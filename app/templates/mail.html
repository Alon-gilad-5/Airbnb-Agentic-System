<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mail Agent Console</title>
  <style>
    :root {
      --bg: #eef3f7;
      --panel: #ffffff;
      --ink: #1f2f39;
      --muted: #617482;
      --accent: #0f766e;
      --accent2: #1f5f8b;
      --border: #d6e0e8;
      --warn: #b45309;
      --danger: #dc2626;
      --success: #16a34a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: linear-gradient(145deg, #e8eff4, #f7fbfd);
      color: var(--ink);
      padding: 24px;
    }
    .layout { max-width: 1100px; margin: 0 auto; display: grid; gap: 16px; }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
    }
    h1 { margin: 0 0 6px 0; font-size: 1.5rem; }
    h2 { margin: 0 0 10px; }
    p { margin: 0; color: var(--muted); }
    .nav { display: flex; gap: 12px; margin-bottom: 4px; }
    .nav a {
      color: var(--accent2);
      text-decoration: none;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 6px;
    }
    .nav a:hover { background: var(--bg); }
    button {
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color: #fff;
      border: 0;
      border-radius: 10px;
      padding: 10px 16px;
      font-weight: 600;
      cursor: pointer;
    }
    button:disabled { opacity: 0.5; cursor: default; }
    button.secondary {
      background: var(--bg);
      color: var(--ink);
      border: 1px solid var(--border);
    }
    .muted { color: var(--muted); font-size: 0.9rem; }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .badge-guest { background: #dbeafe; color: #1e40af; }
    .badge-leave { background: #fef3c7; color: #92400e; }
    .badge-review { background: #fce7f3; color: #9d174d; }
    .badge-unsupported { background: #f3f4f6; color: #6b7280; }
    .badge-non-airbnb { background: #e5e7eb; color: #9ca3af; }
    .badge-bad { background: #fee2e2; color: var(--danger); }
    .badge-good { background: #dcfce7; color: var(--success); }
    .badge-demo { background: #fef3c7; color: var(--warn); }
    .badge-count {
      background: var(--danger);
      color: #fff;
      border-radius: 50%;
      min-width: 22px;
      height: 22px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      padding: 0 5px;
    }

    /* Connection indicator */
    .conn-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
      vertical-align: middle;
    }
    .conn-dot.connected { background: var(--success); }
    .conn-dot.reconnecting { background: var(--warn); animation: pulse 1.2s infinite; }
    .conn-dot.disconnected { background: var(--muted); }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

    /* Notification cards */
    .notif-list { display: grid; gap: 12px; }
    .notif-card {
      border-radius: 12px;
      padding: 14px 14px 14px 18px;
      background: #fcfeff;
      transition: box-shadow 0.15s, opacity 0.3s, max-height 0.4s;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    .notif-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .notif-card.border-urgent { border-left: 5px solid var(--danger); border-top: 1px solid var(--border); border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); }
    .notif-card.border-owner { border-left: 5px solid var(--warn); border-top: 1px solid var(--border); border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); }
    .notif-card.border-info { border-left: 5px solid var(--accent2); border-top: 1px solid var(--border); border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); }
    .notif-card.removing {
      opacity: 0;
      max-height: 0;
      padding: 0 14px 0 18px;
      margin: 0;
      overflow: hidden;
    }
    .notif-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; }
    .notif-title { font-weight: 600; font-size: 1rem; flex: 1; }
    .notif-meta { font-size: 0.85rem; color: var(--muted); margin-top: 4px; }
    .notif-summary {
      margin-top: 6px;
      font-size: 0.88rem;
      color: var(--muted);
      line-height: 1.5;
    }
    .notif-dismiss {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 6px;
      line-height: 1;
    }
    .notif-dismiss:hover { background: var(--bg); color: var(--ink); }

    /* Expanded detail area */
    .notif-detail {
      display: none;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }
    .notif-card.expanded .notif-detail { display: block; }
    .notif-snippet { font-size: 0.9rem; color: var(--ink); margin-bottom: 10px; }

    /* Action UI within notifications */
    .email-actions { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .rating-group { display: flex; gap: 4px; }
    .rating-btn {
      width: 36px; height: 36px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--ink);
      font-weight: 700;
      cursor: pointer;
    }
    .rating-btn.selected { background: var(--accent); color: #fff; border-color: var(--accent); }
    .issues-group { margin-top: 8px; }
    .issues-group label { display: block; margin: 4px 0; font-size: 0.9rem; }
    textarea.action-text {
      width: 100%;
      min-height: 60px;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      font: inherit;
      resize: vertical;
      margin-top: 6px;
    }
    .draft-box {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      border-radius: 10px;
      padding: 10px;
      margin-top: 8px;
      font-size: 0.9rem;
    }
    .reply-style-group { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }
    .reply-style-btn { font-size: 0.85rem; padding: 6px 12px; }
    .dont-reply-btn { background: var(--muted); color: #fff; }
    .action-banner {
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
    }
    .banner-urgent { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
    .banner-owner { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }
    .banner-auto { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
    .banner-info { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }

    /* Steps & results */
    pre {
      background: #f8fbfe;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
      margin: 8px 0 0;
    }
    .steps { display: grid; gap: 10px; }
    .step {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      background: #fcfeff;
    }
    .step h3 { margin: 0 0 6px 0; font-size: 1rem; }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }
    .empty-state .icon { font-size: 2.5rem; margin-bottom: 10px; }

    /* Inbox fallback section */
    .email-list { display: grid; gap: 12px; }
    .email-item {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      background: #fcfeff;
      transition: box-shadow 0.15s;
    }
    .email-item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .email-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 6px; }
    .email-subject { font-weight: 600; font-size: 1rem; }
    .email-meta { font-size: 0.85rem; color: var(--muted); margin-top: 4px; }
    .email-snippet { margin-top: 6px; font-size: 0.9rem; color: var(--ink); }
    .agent-summary {
      margin-top: 6px;
      font-size: 0.88rem;
      color: var(--muted);
      line-height: 1.5;
    }

    .inbox-toggle {
      background: none;
      border: none;
      color: var(--accent2);
      font-weight: 600;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 4px 0;
      text-decoration: underline;
    }
    .inbox-toggle:hover { color: var(--accent); }
  </style>
</head>
<body>
  <main class="layout">
    <section class="card">
      <div class="nav">
        <a href="/">Reviews Console</a>
        <a href="/mail">Mail Console</a>
      </div>
      <div style="display:flex; align-items:center; gap:10px;">
        <h1>Mail Agent Console</h1>
        <span id="notifCount" class="badge-count" style="display:none;">0</span>
      </div>
      <p>
        <span class="conn-dot disconnected" id="connDot"></span>
        <span id="connLabel" class="muted">Connecting...</span>
      </p>
    </section>

    <section class="card">
      <h2>Notifications</h2>
      <div id="notifList" class="notif-list">
        <div class="empty-state" id="emptyState">
          <div class="icon">&#9993;</div>
          <p>Connecting to notification stream...</p>
        </div>
      </div>
    </section>

    <section class="card" id="resultSection" style="display:none;">
      <h2>Action Result</h2>
      <pre id="actionResult"></pre>
      <h3 style="margin-top:12px;">Steps</h3>
      <div id="actionSteps" class="steps"></div>
    </section>

    <section class="card">
      <button class="inbox-toggle" id="inboxToggle">Load full inbox</button>
      <div id="inboxSection" style="display:none; margin-top:12px;">
        <h2>Full Inbox</h2>
        <div id="inboxList" class="email-list">
          <p class="muted">Loading...</p>
        </div>
      </div>
    </section>
  </main>

  <script>
    const notifList = document.getElementById("notifList");
    const emptyState = document.getElementById("emptyState");
    const notifCountEl = document.getElementById("notifCount");
    const connDot = document.getElementById("connDot");
    const connLabel = document.getElementById("connLabel");
    const resultSection = document.getElementById("resultSection");
    const actionResult = document.getElementById("actionResult");
    const actionSteps = document.getElementById("actionSteps");
    const inboxToggle = document.getElementById("inboxToggle");
    const inboxSection = document.getElementById("inboxSection");
    const inboxList = document.getElementById("inboxList");

    const notifications = {};
    const emailActionCache = {};
    let inboxItems = [];

    const COMMON_ISSUES = [
      "Noise complaints", "Cleanliness", "Rule violations",
      "Late checkout", "Property damage", "Communication issues",
    ];

    // ------------------------------------------------------------------
    // Utilities
    // ------------------------------------------------------------------

    function escHtml(str) {
      const d = document.createElement("div");
      d.textContent = str || "";
      return d.innerHTML;
    }

    function timeAgo(isoStr) {
      if (!isoStr) return "";
      const diff = Date.now() - new Date(isoStr).getTime();
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return "just now";
      if (mins < 60) return `${mins}m ago`;
      const hrs = Math.floor(mins / 60);
      if (hrs < 24) return `${hrs}h ago`;
      return `${Math.floor(hrs / 24)}d ago`;
    }

    function categoryBadge(cat) {
      const map = {
        guest_message: "badge-guest",
        leave_review_request: "badge-leave",
        new_property_review: "badge-review",
        unsupported_airbnb: "badge-unsupported",
        non_airbnb: "badge-non-airbnb",
      };
      const cls = map[cat] || "badge-unsupported";
      return `<span class="badge ${cls}">${(cat || "").replace(/_/g, " ")}</span>`;
    }

    function ratingBadge(rating) {
      if (rating == null) return "";
      const cls = rating <= 3 ? "badge-bad" : "badge-good";
      return `<span class="badge ${cls}">${rating}/5</span>`;
    }

    function updateNotifCount() {
      const count = Object.keys(notifications).length;
      notifCountEl.textContent = count;
      notifCountEl.style.display = count > 0 ? "inline-flex" : "none";
      document.title = count > 0 ? `(${count}) Mail Agent Console` : "Mail Agent Console";
      emptyState.style.display = count > 0 ? "none" : "block";
      if (count === 0) {
        emptyState.innerHTML = '<div class="icon">&#10003;</div><p>No pending notifications. You\'re all caught up!</p>';
      }
    }

    // ------------------------------------------------------------------
    // Notification card rendering
    // ------------------------------------------------------------------

    function getBorderClass(notif) {
      const action = notif.action_data || {};
      const importance = action.importance || "";
      const category = notif.category || "";
      const rating = notif.rating;
      if (importance === "high" || (category === "new_property_review" && rating != null && rating <= 2)) {
        return "border-urgent";
      }
      return "border-owner";
    }

    function getAgentSummary(notif) {
      const action = notif.action_data || {};
      const emailAction = action.action || "";
      const importance = action.importance || "";
      const reason = action.reason || "";
      const parts = [];
      if (emailAction) parts.push(`Action: ${emailAction.replace(/_/g, " ")}`);
      if (importance) parts.push(`Importance: ${importance}`);
      if (reason) parts.push(reason);
      return parts.join(" \u00b7 ");
    }

    function renderNotifActions(notif) {
      const action = notif.action_data || {};
      const category = notif.category;
      const emailId = notif.email_id;

      if (category === "leave_review_request") {
        return renderLeaveReviewActions({ email_id: emailId });
      } else if (category === "new_property_review") {
        const item = { email_id: emailId, rating: notif.rating };
        return renderPropertyReviewActions(item, action);
      } else if (category === "guest_message") {
        return renderGuestMessageActions({ email_id: emailId }, action);
      }
      return "";
    }

    function renderLeaveReviewActions(item) {
      let html = `<div class="email-actions">
        <span class="muted">Rate this guest:</span>
        <div class="rating-group" data-email-id="${item.email_id}">`;
      for (let i = 1; i <= 5; i++) {
        html += `<button class="rating-btn" data-rating="${i}">${i}</button>`;
      }
      html += `</div></div>
        <div class="issues-group" data-email-id="${item.email_id}" style="display:none;">
          <strong>Issues (for rating &lt; 3):</strong>`;
      for (const issue of COMMON_ISSUES) {
        html += `<label><input type="checkbox" value="${issue}"> ${issue}</label>`;
      }
      html += `<textarea class="action-text" placeholder="Additional notes..."></textarea>
          <button class="submit-review-btn" data-email-id="${item.email_id}">Generate Review Draft</button>
        </div>`;
      return html;
    }

    function renderPropertyReviewActions(item, action) {
      const emailId = item.email_id;
      const isBad = item.rating != null && item.rating <= 3;
      const opts = action && action.reply_options;
      const draft = action && action.draft;
      const hasDraft = draft != null && draft !== "";

      if (isBad && (opts || hasDraft)) {
        let html = `<div class="email-actions" data-email-id="${emailId}">
          <span class="badge badge-bad">Bad review — choose reply style or don't reply</span>`;
        if (opts && opts.length) {
          html += `<div class="reply-style-group"><span class="muted">Style:</span>`;
          for (const opt of opts) {
            const style = opt.style || opt.label || "option";
            html += `<button class="reply-style-btn secondary" data-email-id="${emailId}" data-reply-style="${escHtml(style)}">${escHtml(style)}</button>`;
          }
          html += `</div>`;
        }
        html += `<div class="issues-group" style="margin-top:8px;">
          <label class="muted">Owner instructions (optional):</label>
          <textarea class="owner-instructions action-text" data-email-id="${emailId}" placeholder="e.g. Emphasize we fixed the cleaning">${action && action.owner_instructions ? escHtml(action.owner_instructions) : ""}</textarea>
        </div>`;
        if (hasDraft) {
          html += `<div class="draft-box" data-email-id="${emailId}">
          <strong>Draft:</strong>
          <textarea class="draft-edit action-text" data-email-id="${emailId}" rows="4">${escHtml(draft)}</textarea>
          </div>`;
        }
        html += `<div style="margin-top:8px;">
          <button class="dont-reply-btn secondary" data-email-id="${emailId}" data-dont-reply="1">Don't reply</button>`;
        if (hasDraft && action.thread_id && action.reply_to) {
          html += ` <button class="approve-send-btn" data-email-id="${emailId}">Approve and send</button>`;
        }
        html += `</div></div>`;
        return html;
      }
      if (isBad) {
        return `<div class="email-actions">
          <span class="badge badge-bad">Bad review — owner consultation required</span>
          <button class="generate-reply-options-btn" data-email-id="${emailId}">Generate reply options</button>
        </div>`;
      }
      return `<div class="email-actions">
        <button class="run-response-btn" data-email-id="${emailId}">Generate Response Draft</button>
      </div>`;
    }

    function renderGuestMessageActions(item, action) {
      const draft = action && action.draft;
      let html = `<div class="email-actions">
        <button class="run-reply-btn" data-email-id="${item.email_id}">Process Message</button>
      </div>`;
      if (draft) {
        html += `<div class="draft-box">
          <strong>Draft:</strong>
          <textarea class="draft-edit action-text" data-email-id="${item.email_id}" rows="4">${escHtml(draft)}</textarea>
          <div style="margin-top:8px;">
            <button class="dont-reply-btn secondary" data-email-id="${item.email_id}" data-dont-reply="1">Don't reply</button>
            ${
              action && action.thread_id && action.reply_to
                ? `<button class="approve-send-btn" data-email-id="${item.email_id}">Approve and send</button>`
                : ""
            }
          </div>
        </div>`;
      }
      return html;
    }

    function addNotifCard(notif) {
      if (notifications[notif.id]) return;
      notifications[notif.id] = notif;
      emailActionCache[notif.email_id] = notif.action_data || {};

      const card = document.createElement("div");
      card.className = `notif-card ${getBorderClass(notif)}`;
      card.dataset.notifId = notif.id;
      card.dataset.emailId = notif.email_id;

      const summary = getAgentSummary(notif);
      const draft = (notif.action_data || {}).draft || "";
      const draftPreview = draft ? (draft.length > 150 ? draft.substring(0, 150) + "..." : draft) : "";

      card.innerHTML = `
        <div class="notif-header">
          <div style="flex:1;">
            <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
              <span class="notif-title">${escHtml(notif.subject)}</span>
              ${categoryBadge(notif.category)}
              ${ratingBadge(notif.rating)}
            </div>
            <div class="notif-meta">
              From: ${escHtml(notif.sender)}
              ${notif.guest_name ? " \u00b7 Guest: " + escHtml(notif.guest_name) : ""}
              ${notif.created_at ? " \u00b7 " + timeAgo(notif.created_at) : ""}
            </div>
          </div>
          <button class="notif-dismiss" title="Dismiss">&times;</button>
        </div>
        ${summary ? `<div class="notif-summary">${escHtml(summary)}</div>` : ""}
        ${draftPreview ? `<div class="draft-box" style="margin-top:8px;"><strong>Draft:</strong> ${escHtml(draftPreview)}</div>` : ""}
        <div class="notif-detail">
          <div class="notif-snippet">${escHtml(notif.snippet)}</div>
          ${renderNotifActions(notif)}
        </div>`;

      card.querySelector(".notif-dismiss").addEventListener("click", (e) => {
        e.stopPropagation();
        dismissNotification(notif.id, card);
      });

      card.addEventListener("click", (e) => {
        if (e.target.closest("button") || e.target.closest("textarea") || e.target.closest("input") || e.target.closest("label")) return;
        card.classList.toggle("expanded");
        if (card.classList.contains("expanded")) {
          bindActionHandlersInCard(card);
        }
      });

      const firstEmpty = notifList.querySelector(".empty-state");
      if (firstEmpty) {
        notifList.insertBefore(card, firstEmpty);
      } else {
        notifList.prepend(card);
      }
      updateNotifCount();
    }

    function removeNotifCard(notifId) {
      const card = notifList.querySelector(`[data-notif-id="${notifId}"]`);
      if (card) {
        card.classList.add("removing");
        setTimeout(() => { card.remove(); }, 400);
      }
      delete notifications[notifId];
      updateNotifCount();
    }

    // ------------------------------------------------------------------
    // Action handlers (bound per-card when expanded)
    // ------------------------------------------------------------------

    function bindActionHandlersInCard(card) {
      card.querySelectorAll(".rating-btn").forEach(btn => {
        if (btn._bound) return;
        btn._bound = true;
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const group = btn.closest(".rating-group");
          group.querySelectorAll(".rating-btn").forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");
          const emailId = group.dataset.emailId;
          const rating = parseInt(btn.dataset.rating);
          const issuesDiv = card.querySelector(`.issues-group[data-email-id="${emailId}"]`);
          if (rating < 3) {
            issuesDiv.style.display = "block";
          } else {
            issuesDiv.style.display = "none";
            submitMailAction(emailId, "rate_guest", { rating });
          }
        });
      });

      card.querySelectorAll(".submit-review-btn").forEach(btn => {
        if (btn._bound) return;
        btn._bound = true;
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const emailId = btn.dataset.emailId;
          const group = card.querySelector(`.rating-group[data-email-id="${emailId}"]`);
          const selected = group ? group.querySelector(".rating-btn.selected") : null;
          const rating = selected ? parseInt(selected.dataset.rating) : 1;
          const issuesDiv = card.querySelector(`.issues-group[data-email-id="${emailId}"]`);
          const issues = Array.from(issuesDiv.querySelectorAll("input:checked")).map(cb => cb.value);
          const freeText = issuesDiv.querySelector("textarea").value.trim() || null;
          submitMailAction(emailId, "rate_guest", { rating, issues, free_text: freeText });
        });
      });

      card.querySelectorAll(".generate-reply-options-btn").forEach(btn => {
        if (btn._bound) return;
        btn._bound = true;
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          submitMailAction(btn.dataset.emailId, "approve_response", { approved: true });
        });
      });

      card.querySelectorAll(".reply-style-btn").forEach(btn => {
        if (btn._bound) return;
        btn._bound = true;
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const emailId = btn.dataset.emailId;
          const replyStyle = btn.dataset.replyStyle;
          const instructionsEl = card.querySelector(`.owner-instructions[data-email-id="${emailId}"]`);
          const ownerInstructions = instructionsEl ? instructionsEl.value.trim() : null;
          submitMailAction(emailId, "approve_response", { reply_style: replyStyle, owner_instructions: ownerInstructions || undefined });
        });
      });

      card.querySelectorAll(".dont-reply-btn").forEach(btn => {
        if (btn._bound) return;
        btn._bound = true;
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          submitMailAction(btn.dataset.emailId, "don_t_reply", { don_t_reply: true });
        });
      });

      card.querySelectorAll(".approve-send-btn").forEach(btn => {
        if (btn._bound) return;
        btn._bound = true;
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const emailId = btn.dataset.emailId;
          const action = emailActionCache[emailId];
          if (!action || !action.thread_id || !action.reply_to) {
            resultSection.style.display = "block";
            actionResult.textContent = "Missing reply metadata; try generating options again.";
            return;
          }
          const draftEl = card.querySelector(`.draft-edit[data-email-id="${emailId}"]`);
          const draftText = draftEl ? draftEl.value.trim() : (action.draft || "");
          if (!draftText) {
            resultSection.style.display = "block";
            actionResult.textContent = "Draft is empty.";
            return;
          }
          submitMailAction(emailId, "approve_response", {
            approve_and_send: true,
            edited_draft: draftText,
            thread_id: action.thread_id,
            reply_to: action.reply_to,
            subject: action.subject || "Re: (no subject)",
            in_reply_to: action.in_reply_to || undefined,
            references: action.references || undefined,
          });
        });
      });

      card.querySelectorAll(".run-response-btn").forEach(btn => {
        if (btn._bound) return;
        btn._bound = true;
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          submitMailAction(btn.dataset.emailId, "approve_response", { approved: true });
        });
      });

      card.querySelectorAll(".run-reply-btn").forEach(btn => {
        if (btn._bound) return;
        btn._bound = true;
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          submitMailAction(btn.dataset.emailId, "approve_response", { approved: true });
        });
      });
    }

    // ------------------------------------------------------------------
    // API calls
    // ------------------------------------------------------------------

    async function submitMailAction(emailId, actionType, extra) {
      resultSection.style.display = "block";
      actionResult.textContent = "Processing...";
      actionSteps.innerHTML = "";

      const body = { email_id: emailId, action_type: actionType, ...extra };

      try {
        const res = await fetch("/api/mail/action", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        const data = await res.json();
        actionResult.textContent = data.response ?? `(error) ${data.error}`;
        renderSteps(data.steps || [], actionSteps);

        if (data.mail_actions && data.mail_actions.length) {
          const match = data.mail_actions.find(a => a.email_id === emailId);
          if (match) {
            emailActionCache[emailId] = match;
          }
        }
      } catch (err) {
        actionResult.textContent = String(err);
      }
    }

    async function dismissNotification(notifId, card) {
      card.classList.add("removing");
      try {
        await fetch(`/api/mail/notifications/${notifId}/dismiss`, { method: "POST" });
      } catch (e) { /* best effort */ }
      setTimeout(() => {
        card.remove();
        delete notifications[notifId];
        updateNotifCount();
      }, 400);
    }

    function renderSteps(steps, container) {
      container.innerHTML = "";
      if (!steps || !steps.length) {
        container.textContent = "No steps recorded.";
        return;
      }
      for (const step of steps) {
        const div = document.createElement("div");
        div.className = "step";
        div.innerHTML = `
          <h3>${escHtml(step.module)}</h3>
          <strong>prompt</strong>
          <pre>${JSON.stringify(step.prompt, null, 2)}</pre>
          <strong>response</strong>
          <pre>${JSON.stringify(step.response, null, 2)}</pre>`;
        container.appendChild(div);
      }
    }

    // ------------------------------------------------------------------
    // Load existing notifications
    // ------------------------------------------------------------------

    async function loadNotifications() {
      try {
        const res = await fetch("/api/mail/notifications");
        const data = await res.json();
        if (data.status === "ok" && data.notifications) {
          for (const notif of data.notifications.reverse()) {
            addNotifCard(notif);
          }
        }
        updateNotifCount();
      } catch (e) {
        console.error("Failed to load notifications:", e);
      }
    }

    // ------------------------------------------------------------------
    // SSE connection
    // ------------------------------------------------------------------

    function connectSSE() {
      const evtSource = new EventSource("/api/mail/notifications/stream");

      evtSource.onopen = () => {
        connDot.className = "conn-dot connected";
        connLabel.textContent = "Live — listening for new emails";
      };

      evtSource.onmessage = (e) => {
        try {
          const event = JSON.parse(e.data);
          if (event.type === "new" && event.notification) {
            addNotifCard(event.notification);
          } else if (event.type === "handled" && event.notification_id) {
            removeNotifCard(event.notification_id);
          } else if (event.type === "dismissed" && event.notification_id) {
            removeNotifCard(event.notification_id);
          }
        } catch (err) {
          // heartbeat or malformed — ignore
        }
      };

      evtSource.onerror = () => {
        connDot.className = "conn-dot reconnecting";
        connLabel.textContent = "Reconnecting...";
      };

      return evtSource;
    }

    // ------------------------------------------------------------------
    // Full inbox fallback
    // ------------------------------------------------------------------

    function renderAgentBanner(action) {
      if (!action) return "";
      const reqOwner = action.requires_owner;
      const emailAction = action.action || "";
      const importance = action.importance || "";
      const category = action.category || "";
      const draft = action.draft || "";
      const reason = action.reason || "";

      let bannerClass = "banner-info";
      let bannerText = "";

      if (importance === "high" || (category === "new_property_review" && action.rating != null && action.rating <= 2)) {
        bannerClass = "banner-urgent";
        bannerText = "Urgent \u2014 requires immediate attention";
      } else if (reqOwner) {
        bannerClass = "banner-owner";
        bannerText = "Owner action needed";
      } else if (emailAction === "draft_reply" || emailAction === "auto_thank") {
        bannerClass = "banner-auto";
        bannerText = "Agent handled automatically";
      } else if (emailAction === "no_action") {
        bannerClass = "banner-info";
        bannerText = "No action required";
      } else {
        bannerClass = "banner-info";
        bannerText = `Agent decision: ${emailAction.replace(/_/g, " ")}`;
      }

      let html = `<div class="action-banner ${bannerClass}">${escHtml(bannerText)}</div>`;
      let details = [];
      if (emailAction) details.push(`Action: ${emailAction.replace(/_/g, " ")}`);
      if (importance) details.push(`Importance: ${importance}`);
      if (reason) details.push(`Reason: ${reason}`);
      if (details.length) {
        html += `<div class="agent-summary">${escHtml(details.join(" \u00b7 "))}</div>`;
      }
      if (draft) {
        const preview = draft.length > 200 ? draft.substring(0, 200) + "..." : draft;
        html += `<div class="draft-box"><strong>Draft reply:</strong><br>${escHtml(preview)}</div>`;
      }
      return html;
    }

    function renderInbox(items, actionsByEmail) {
      actionsByEmail = actionsByEmail || {};
      inboxItems = items || [];
      inboxList.innerHTML = "";
      if (!items.length) {
        inboxList.innerHTML = '<p class="muted">No emails found.</p>';
        return;
      }
      for (const item of items) {
        if (item.category === "non_airbnb") continue;
        const div = document.createElement("div");
        div.className = "email-item";
        div.dataset.emailId = item.email_id;
        const action = actionsByEmail[item.email_id];
        div.innerHTML = `
          <div class="email-header">
            <span class="email-subject">${escHtml(item.subject)}</span>
            <span>${categoryBadge(item.category)} ${ratingBadge(item.rating)}</span>
          </div>
          <div class="email-meta">
            From: ${escHtml(item.sender)} \u00b7 ${escHtml(item.date)}
            ${item.guest_name ? " \u00b7 Guest: " + escHtml(item.guest_name) : ""}
          </div>
          <div class="email-snippet">${escHtml(item.snippet)}</div>
          ${renderAgentBanner(action)}`;
        inboxList.appendChild(div);
      }
    }

    let inboxLoaded = false;
    inboxToggle.addEventListener("click", async () => {
      if (inboxLoaded) {
        inboxSection.style.display = inboxSection.style.display === "none" ? "block" : "none";
        return;
      }
      inboxSection.style.display = "block";
      inboxToggle.textContent = "Loading...";
      try {
        const res = await fetch("/api/mail/inbox");
        const data = await res.json();
        if (data.status === "ok") {
          const actions = data.mail_actions || [];
          const actionMap = {};
          for (const act of actions) {
            if (act.email_id) actionMap[act.email_id] = act;
          }
          renderInbox(data.items || [], actionMap);
          inboxLoaded = true;
          inboxToggle.textContent = "Hide full inbox";
        } else {
          inboxList.innerHTML = `<p style="color:var(--danger)">${escHtml(data.error)}</p>`;
          inboxToggle.textContent = "Load full inbox";
        }
      } catch (err) {
        inboxList.innerHTML = `<p style="color:var(--danger)">${escHtml(String(err))}</p>`;
        inboxToggle.textContent = "Load full inbox";
      }
    });

    // ------------------------------------------------------------------
    // Init
    // ------------------------------------------------------------------

    loadNotifications();
    connectSSE();
  </script>
</body>
</html>
