<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Market Watch</title>
  <link rel="stylesheet" href="/static/base.css">
  <style>
    .alerts-grid { display:grid; gap:12px; }
    .alert-card {
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      border-left:4px solid var(--accent);
      padding:14px 16px;
      transition: box-shadow 0.15s ease;
    }
    .alert-card:hover { box-shadow:0 2px 10px rgba(0,0,0,0.06); }
    .alert-card.severity-high   { border-left-color:var(--danger); }
    .alert-card.severity-medium { border-left-color:var(--warn); }
    .alert-card.severity-low    { border-left-color:var(--accent); }
    .alert-header { display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-bottom:6px; }
    .badge {
      font-size:0.75rem; font-weight:600; border-radius:999px; padding:2px 10px;
      text-transform:uppercase; letter-spacing:0.03em;
    }
    .badge-high   { background:#fee2e2; color:#991b1b; }
    .badge-medium { background:#fef3c7; color:#92400e; }
    .badge-low    { background:#d1fae5; color:#065f46; }
    .badge-type {
      font-size:0.75rem; font-weight:600; border-radius:999px; padding:2px 10px;
      background:#dbeafe; color:#1e40af;
    }
    .alert-title { font-weight:700; font-size:1.05rem; margin:0 0 4px 0; color:var(--ink); }
    .alert-meta { font-size:0.85rem; color:var(--muted); margin-bottom:6px; }
    .alert-meta span + span::before { content:"\00b7"; margin:0 6px; }
    .alert-summary { font-size:0.95rem; line-height:1.55; color:var(--ink); margin:0; }
    .alert-footer { margin-top:10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .source-link {
      font-size:0.85rem; color:var(--accent2); text-decoration:none; font-weight:600;
    }
    .source-link:hover { text-decoration:underline; }
    .evidence-toggle {
      background:none; border:1px solid var(--border); color:var(--accent2);
      font-size:0.82rem; padding:4px 12px; border-radius:8px; cursor:pointer; font-weight:600;
    }
    .evidence-toggle:hover { background:#f0f5fa; }
    .evidence-panel {
      display:none; margin-top:10px; background:#f8fbfe; border:1px solid var(--border);
      border-radius:10px; padding:12px; overflow:auto; white-space:pre-wrap;
      word-break:break-word; font-size:0.85rem; font-family:monospace; color:var(--muted);
    }
    .evidence-panel.open { display:block; }
    .row { display:flex; gap:10px; align-items:center; margin-top:10px; }
    .empty-state {
      text-align:center; padding:40px 20px; color:var(--muted); font-size:1rem;
    }
    .empty-state p { margin:8px 0; }
    .nav a { position: relative; }
    .nav-badge {
      background: var(--danger);
      color: #fff;
      border-radius: 50%;
      min-width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 0 4px;
      margin-left: 4px;
      vertical-align: top;
    }
    .nav-badge:empty { display: none; }
  </style>
</head>
<body>
  <main class="layout">
    <section class="card">
      <div class="nav">
        <a href="/">Reviews Console</a>
        <a href="/mail">Mail Console<span class="nav-badge" id="navMailBadge"></span></a>
        <a href="/market-watch" class="active" aria-current="page">Market Watch</a>
      </div>
      <h1>Market Watch</h1>
      <p>Weather threats, nearby events, and demand signals detected for your property.</p>
    </section>

    <section class="card">
      <div class="row" style="margin-top:0; justify-content:space-between;">
        <h2 style="margin:0;">Alerts</h2>
        <div class="row" style="margin-top:0;">
          <span id="status" class="muted">Loading...</span>
          <button id="refreshBtn" class="secondary" style="padding:6px 14px; font-size:0.9rem;">Refresh</button>
        </div>
      </div>
    </section>

    <div id="alertsList" class="alerts-grid"></div>
  </main>

  <script>
    const alertsEl = document.getElementById("alertsList");
    const statusEl = document.getElementById("status");
    const refreshBtn = document.getElementById("refreshBtn");
    const PROPERTY_PROFILE_STORAGE_KEY = "active_property_profile_id";
    let selectedProfile = null;

    function escHtml(s) {
      const d = document.createElement("div");
      d.textContent = s || "";
      return d.innerHTML;
    }

    function formatDate(iso) {
      if (!iso) return null;
      try {
        const d = new Date(iso.endsWith("Z") ? iso : iso + "Z");
        if (isNaN(d.getTime())) return iso;
        const now = new Date();
        const diffMs = d.getTime() - now.getTime();
        const diffDays = Math.round(diffMs / 86400000);
        const dateStr = d.toLocaleDateString(undefined, { month: "short", day: "numeric" });
        if (diffDays === 0) return "Today";
        if (diffDays === 1) return "Tomorrow";
        if (diffDays === -1) return "Yesterday";
        if (diffDays > 1 && diffDays <= 14) return `In ${diffDays} days (${dateStr})`;
        if (diffDays < -1 && diffDays >= -14) return `${Math.abs(diffDays)} days ago`;
        return dateStr;
      } catch { return iso; }
    }

    function formatRange(start, end) {
      const s = formatDate(start);
      const e = formatDate(end);
      if (!s) return "";
      if (!e || s === e) return s;
      return `${s} \u2013 ${e}`;
    }

    function buildRunPayload(profile) {
      if (!profile) return {};
      const payload = {};
      if (profile.owner_id) payload.owner_id = profile.owner_id;
      if (profile.owner_name) payload.owner_name = profile.owner_name;
      if (profile.property_id) payload.property_id = profile.property_id;
      if (profile.property_name) payload.property_name = profile.property_name;
      if (profile.city) payload.city = profile.city;
      if (profile.region) payload.region = profile.region;
      if (profile.latitude !== null && profile.latitude !== undefined) payload.latitude = profile.latitude;
      if (profile.longitude !== null && profile.longitude !== undefined) payload.longitude = profile.longitude;
      return payload;
    }

    function buildAlertsQuery(profile) {
      const params = new URLSearchParams();
      params.set("limit", "50");
      if (profile && profile.owner_id) params.set("owner_id", profile.owner_id);
      if (profile && profile.property_id) params.set("property_id", profile.property_id);
      return params.toString();
    }

    async function resolveSelectedProfile() {
      try {
        const res = await fetch("/api/property_profiles");
        const data = await res.json();
        const profiles = Array.isArray(data.profiles) ? data.profiles : [];
        if (!profiles.length) return null;

        let storedProfileId = null;
        try {
          storedProfileId = localStorage.getItem(PROPERTY_PROFILE_STORAGE_KEY);
        } catch (err) {
          // Ignore storage errors in restricted browser contexts.
        }

        const defaultProfileId = (
          typeof data.default_profile_id === "string"
            ? data.default_profile_id
            : profiles[0].profile_id
        );
        const selectedId = (
          storedProfileId && profiles.some((p) => p.profile_id === storedProfileId)
            ? storedProfileId
            : defaultProfileId
        );
        return profiles.find((p) => p.profile_id === selectedId) || profiles[0];
      } catch (err) {
        return null;
      }
    }

    function renderAlerts(alerts) {
      alertsEl.innerHTML = "";
      if (!alerts || !alerts.length) {
        alertsEl.innerHTML = `
          <div class="card empty-state">
            <p><strong>No alerts yet</strong></p>
            <p>The market watch agent checks periodically for weather, events, and demand signals relevant to your property.</p>
          </div>`;
        return;
      }
      for (const a of alerts) {
        const sev = (a.severity || "low").toLowerCase();
        const card = document.createElement("div");
        card.className = `alert-card severity-${sev}`;

        const dateRange = formatRange(a.start_at_utc, a.end_at_utc);
        const metaParts = [];
        if (dateRange) metaParts.push(dateRange);
        if (a.source_name) metaParts.push(a.source_name);
        if (a.city) metaParts.push(a.city);

        let footerHtml = "";
        const footerParts = [];
        if (a.source_url) {
          footerParts.push(`<a class="source-link" href="${escHtml(a.source_url)}" target="_blank" rel="noopener">View source</a>`);
        }
        if (a.evidence && Object.keys(a.evidence).length) {
          const evidenceId = `ev-${a.id}`;
          footerParts.push(`<button class="evidence-toggle" onclick="document.getElementById('${evidenceId}').classList.toggle('open'); this.textContent = document.getElementById('${evidenceId}').classList.contains('open') ? 'Hide details' : 'Show details'">Show details</button>`);
          footerParts.push(`<div id="${evidenceId}" class="evidence-panel">${escHtml(JSON.stringify(a.evidence, null, 2))}</div>`);
        }
        if (footerParts.length) {
          footerHtml = `<div class="alert-footer">${footerParts.join("\n")}</div>`;
        }

        card.innerHTML = `
          <div class="alert-header">
            <span class="badge badge-${sev}">${escHtml(sev)}</span>
            <span class="badge-type">${escHtml(a.alert_type || "alert")}</span>
          </div>
          <div class="alert-title">${escHtml(a.title)}</div>
          ${metaParts.length ? `<div class="alert-meta">${metaParts.map(m => `<span>${escHtml(m)}</span>`).join("")}</div>` : ""}
          <p class="alert-summary">${escHtml(a.summary)}</p>
          ${footerHtml}
        `;
        alertsEl.appendChild(card);
      }
    }

    async function runMarketWatch(profile) {
      try {
        const payload = buildRunPayload(profile);
        const res = await fetch("/api/market_watch/run", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (data.status === "error") {
          return data.error || "Market watch run failed.";
        }
        return null;
      } catch (err) {
        return String(err);
      }
    }

    async function loadAlerts(profile, runError) {
      try {
        const query = buildAlertsQuery(profile);
        const res = await fetch(`/api/market_watch/alerts?${query}`);
        const data = await res.json();
        if (data.status === "error") {
          alertsEl.innerHTML = `<div class="status-banner error">${escHtml(data.error || "Unknown error")}</div>`;
          statusEl.textContent = "Error";
          return;
        }

        renderAlerts(data.alerts || []);
        const n = (data.alerts || []).length;
        const propertyLabel = (
          profile && (profile.property_name || profile.property_id)
            ? ` for ${profile.property_name || profile.property_id}`
            : ""
        );
        if (runError) {
          statusEl.textContent = `Run issue${propertyLabel}; showing ${n} alert${n === 1 ? "" : "s"}`;
          return;
        }
        statusEl.textContent = n ? `${n} alert${n > 1 ? "s" : ""}${propertyLabel}` : `No alerts${propertyLabel}`;
      } catch (err) {
        alertsEl.innerHTML = `<div class="status-banner error">${escHtml(String(err))}</div>`;
        statusEl.textContent = "Failed";
      }
    }

    async function refreshMarketWatch() {
      refreshBtn.disabled = true;
      statusEl.innerHTML = '<span class="inline-spinner" aria-hidden="true"></span> Loading...';
      try {
        selectedProfile = await resolveSelectedProfile();
        const runError = await runMarketWatch(selectedProfile);
        await loadAlerts(selectedProfile, runError);
      } finally {
        refreshBtn.disabled = false;
      }
    }

    refreshBtn.addEventListener("click", refreshMarketWatch);
    refreshMarketWatch();

    // Mark market watch as seen and update nav badges
    try { localStorage.setItem("market_watch_last_seen", new Date().toISOString()); } catch {}

    (function() {
      const navMailBadge = document.getElementById("navMailBadge");
      function updateNavBadges() {
        fetch("/api/nav/badges")
          .then(r => r.json())
          .then(d => {
            navMailBadge.textContent = d.mail_count > 0 ? d.mail_count : "";
          })
          .catch(() => {});
      }
      updateNavBadges();
      setInterval(updateNavBadges, 30000);
    })();
  </script>
</body>
</html>
